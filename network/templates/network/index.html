{% extends "network/layout.html" %}

{% block body %}
{% if user.is_authenticated %}
  <form id="new-post-form" method="POST" class="mb-4">
    {% csrf_token %}
    <div class="form-group">
      <textarea class="form-control" name="content" placeholder="What's happening?" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Post</button>
  </form>
{% endif %}
  {% for post in posts %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">
          <a href="{% url 'profile' post.author.username %}">{{ post.author.username }}</a>
        </h5>
        <p class="card-text">
          <span class="post-content">{{ post.content }}</span>
          {% if post.edited %}
            <small class="text-muted">(edited)</small>
          {% endif %}
        </p>
        <p class="card-text">
          <small class="text-muted">
            {{ post.timestamp|date:"M d, Y H:i" }} | 
            Likes: <span class="like-count">{{ post.likes.count }}</span>
          </small>
        </p>

        <!-- Like Button -->
        <button class="btn btn-sm btn-outline-primary like-btn" data-post-id="{{ post.id }}">
          {% if user in post.likes.all %}
            ğŸ‘
          {% else %}
            ğŸ‘
          {% endif %}
        </button>

        <!-- Edit Button -->
        {% if user == post.author %}
          <button class="btn btn-sm btn-outline-secondary edit-btn" data-post-id="{{ post.id }}">Edit</button>
        {% endif %}
      </div>
    </div>
  {% endfor %}

<!-- Pagination controls -->
<div class="pagination">
  {% if posts.has_previous %}
    <a class="btn btn-outline-primary" href="?page={{ posts.previous_page_number }}">Previous</a>
  {% endif %}
  
  <span class="mx-2">Page {{ posts.number }} of {{ posts.paginator.num_pages }}</span>

  {% if posts.has_next %}
    <a class="btn btn-outline-primary" href="?page={{ posts.next_page_number }}">Next</a>
  {% endif %}
</div>
<!-- Script that enables editing your own posts with textarea + AJAX save -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".edit-btn").forEach(button => {
    button.onclick = () => {
      const postId = button.dataset.postId;
      const postCard = button.closest(".card-body");
      // only selects the post content, not timestamp/likes
      const contentSpan = postCard.querySelector(".post-content");

      const textarea = document.createElement("textarea");
      textarea.className = "form-control mb-2";
      textarea.value = contentSpan.innerText;
      contentSpan.replaceWith(textarea);

      const saveBtn = document.createElement("button");
      saveBtn.className = "btn btn-sm btn-primary";
      saveBtn.innerText = "Save";
      postCard.appendChild(saveBtn);

      saveBtn.onclick = () => {
        fetch(`/edit_post/${postId}`, {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
          },
          body: new URLSearchParams({ "content": textarea.value })
        })
        .then(response => response.json())
        .then(data => {
          if (data.content) {
            const newSpan = document.createElement("span");
            newSpan.className = "post-content";
            newSpan.innerText = data.content;

            const parentP = textarea.closest("p");
            const editedTag = parentP.querySelector("small.text-muted");
            if (editedTag) {
              parentP.insertBefore(newSpan, editedTag);
            } else {
              parentP.appendChild(newSpan);
            }

            textarea.remove();
            saveBtn.remove();
          } else {
            alert(data.error);
          }
        });
      };
    };
  });
});
</script>
<!-- Like/Unlike button Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Like/Unlike functionality
  document.querySelectorAll(".like-btn").forEach(button => {
    button.onclick = () => {
      const postId = button.dataset.postId;
      const postCard = button.closest(".card-body");
      const likeCountSpan = postCard.querySelector(".like-count");

      fetch(`/toggle_like/${postId}`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.likes_count !== undefined) {
          likeCountSpan.innerText = data.likes_count;
          button.innerText = data.liked ? "ğŸ‘" : "ğŸ‘";
        } else {
          alert(data.error);
        }
      });
    };
  });
});
</script>
{% endblock %}
